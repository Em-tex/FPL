<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">Melding om grensekryssende droneflyging</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
</head>
<body>

    <header>
        <div class="header-wrapper">
            <div class="header-container">
                <div class="logo-group">
                    <a href="https://www.luftfartstilsynet.no/droner/" id="logoLink" target="_blank" class="logo-link">
                        <img src="logo.png" alt="Luftfartstilsynet Logo" class="logo">
                    </a>
                    <h1 data-i18n="mainHeader">Melding om grensekryssende droneflyging</h1>
                </div>
                <button id="langToggle" class="btn-lang no-print" onclick="toggleLanguage()">Switch to English</button>
            </div>
        </div>
    </header>

    <div class="container">
        
        <div class="intro-block no-print">
            <p data-i18n="txtOpenCatNote" style="margin: 0;"><strong>Merk:</strong> Flyging i <em>åpen kategori</em> krever ikke innsending av dette skjemaet.</p>
        </div>

        <form id="flightForm" novalidate>
            
            <section class="card form-section">
                <h2 data-i18n="sect1Header">1. Operatør og Tillatelser</h2>
                
                <div class="grid-2">
                    <div class="form-group full-width">
                        <label for="operatorName" class="required" data-i18n="lblOperatorName">Operatørnavn:</label>
                        <input type="text" id="operatorName" name="operatorName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="operatorEmail" class="required" data-i18n="lblOperatorEmail">Operatør E-post:</label>
                        <input type="email" id="operatorEmail" name="operatorEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="operatorPhone" class="required" data-i18n="lblOperatorPhone">Operatør Telefon:</label>
                        <input type="tel" id="operatorPhone" name="operatorPhone" required>
                    </div>

                    <div class="form-group">
                        <label for="pilotName" class="required" data-i18n="lblPilotName">Navn på Pilot:</label>
                        <input type="text" id="pilotName" name="pilotName" required>
                    </div>
                    <div class="form-group">
                        <label for="pilotPhone" class="required" data-i18n="lblPilotPhone">Pilot Telefon (tilgjengelig under flyging):</label>
                        <input type="tel" id="pilotPhone" name="pilotPhone" required>
                    </div>
                </div>

                <div class="sub-section">
                    <h3 data-i18n="subHeaderAuth">Kategori og Autorisasjoner</h3>
                    
                    <div class="form-group full-width">
                        <label for="flightCategory" data-i18n="lblFlightCategory">Luftfartskategori:</label>
                        <select id="flightCategory" name="flightCategory">
                            <option value="Civil" data-i18n="optCivil" selected>Sivil Luftfart (EASA)</option>
                            <option value="State" data-i18n="optState">Militær / Statsluftfart (Non-EASA)</option>
                        </select>
                    </div>

                    <div id="civilAuthContainer" class="grid-2 mt-small">
                        <div class="form-group">
                            <label for="permitType" data-i18n="lblPermitType">Operasjonstillatelse:</label>
                            <select id="permitType" name="permitType">
                                <option value="nor_oat" data-i18n="optNorOat">Norsk operasjonstillatelse (NOR-OAT)</option>
                                <option value="easa_oat" data-i18n="optEasaOat">Operasjonstillatelse fra annet EASA land</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="oatNumber" class="required" data-i18n="lblOat">OAT-nummer:</label>
                            <div class="input-prefix-group">
                                <span id="oatPrefix" class="prefix">NOR-OAT-</span>
                                <input type="text" id="oatNumber" name="oatNumber" required>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <div class="checkbox-group" style="margin-bottom: 15px;">
                                <label>
                                    <input type="checkbox" id="isIntWaters" name="isIntWaters">
                                    <span data-i18n="chkIntWaters">Passering til/fra internasjonalt farvann</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="cboNumber" data-i18n="lblCbo">Cross border tillatelse (CBO):</label>
                            <input type="text" id="cboNumber" name="cboNumber">
                            <small class="help-text" data-i18n="helpCbo">Kreves for utenlandske operatører, eller norske operatører utenfor int. farvann.</small>
                        </div>
                    </div>

                    <div id="stateAuthContainer" class="grid-2 mt-small hidden">
                        <div class="form-group full-width">
                            <div class="info-notice">
                                <strong data-i18n="disclaimerTitle">Merk:</strong> <span data-i18n="txtDiploNote">Diplomatisk klarering kreves for utenlandsk statsluftfart.</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="stateNat" data-i18n="lblStateNat">Operatørens nasjonalitet:</label>
                            <select id="stateNat" name="stateNat">
                                <option value="NO" data-i18n="optNatNo">Norge</option>
                                <option value="Foreign" data-i18n="optNatForeign">Annet land</option>
                            </select>
                        </div>

                        <div class="form-group hidden" id="diploRefContainer">
                            <label for="diploRef" class="required" data-i18n="lblDiplo">Referanse for diplomatisk klarering:</label>
                            <input type="text" id="diploRef" name="diploRef">
                        </div>
                    </div>
                 </div>
            </section>

            <section class="card form-section">
                <h2 data-i18n="sect2Header">2. Fartøy (Drone)</h2>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="manufacturer" class="required" data-i18n="lblManufacturer">Produsent:</label>
                        <input type="text" id="manufacturer" name="manufacturer" required>
                    </div>
                    <div class="form-group">
                        <label for="model" class="required" data-i18n="lblModel">Modell:</label>
                        <input type="text" id="model" name="model" required>
                    </div>
                    
                    <div class="form-group">
                         <label for="mtom" class="required" data-i18n="lblMtom">MTOM (kg):</label>
                         <input type="number" step="0.1" id="mtom" name="mtom" required>
                    </div>

                    <div class="form-group">
                        <label for="powerplant" data-i18n="lblPowerplant">Drivlinje:</label>
                        <select id="powerplant" name="powerplant">
                            <option value="Electric" data-i18n="optElectric">Elektrisk (Batteri)</option>
                            <option value="Piston" data-i18n="optPiston">Stempelmotor / Hybrid</option>
                            <option value="Turbine" data-i18n="optTurbine">Turbin / Jet</option>
                            <option value="None" data-i18n="optNone">Ingen (Glidefly/Ballong)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="droneType" data-i18n="lblDroneType">Fartøytype:</label>
                        <select id="droneType" name="droneType">
                            <option value="Multirotor" data-i18n="optMultirotor">Multirotor</option>
                            <option value="Fixed Wing" data-i18n="optFixedWing">Fixed Wing (Fly)</option>
                            <option value="Helicopter" data-i18n="optHelicopter">Helikopter</option>
                            <option value="Hybrid" data-i18n="optHybrid">Hybrid (VTOL)</option>
                            <option value="Other" data-i18n="optOther">Annet</option>
                        </select>
                        <div id="typeOtherContainer" class="hidden" style="margin-top: 5px;">
                            <input type="text" id="typeOtherText" name="typeOtherText" placeholder="Beskriv...">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="color" class="required" data-i18n="lblColor">Farge / Kjennetegn:</label>
                        <input type="text" id="color" name="color" required>
                    </div>
                </div>

                <div class="form-group full-width" style="margin-top: 20px;">
                    <label style="margin-bottom: 5px;" data-i18n="lblEc">Elektronisk Synlighet:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="ec" value="None" id="ecNone"> <span data-i18n="lblEcNone">Ingen</span></label>
                        <label><input type="checkbox" name="ec" value="Mode S"> Mode S</label>
                        <label><input type="checkbox" name="ec" value="Mode S ES"> Mode S ES (ADS-B)</label>
                        <label><input type="checkbox" name="ec" value="ADS-L"> ADS-L</label>
                        <label><input type="checkbox" name="ec" value="Remote ID" id="ecRemoteId"> Remote ID</label>
                        <label><input type="checkbox" id="ecOtherCheck" name="ec" value="Annet"> <span data-i18n="lblEcOther">Annet</span></label>
                    </div>
                    
                    <div id="ridOpNumContainer" class="hidden" style="margin-top: 15px; background: #eef4fa; padding: 10px; border-radius: 4px; border: 1px solid #d0e0f0;">
                         <label for="ridOpNum" class="required" data-i18n="lblRidOpNum">UAS Operatørnummer (fra Remote ID):</label>
                         <div style="display: flex; gap: 10px; align-items: center;">
                             <input type="text" id="ridOpNum" name="ridOpNum" maxlength="16" placeholder="16 alfanumeriske tegn" style="flex: 1; font-family: monospace;">
                             <span id="ridCounter" style="font-size: 0.85rem; color: #666; width: 50px;">0/16</span>
                         </div>
                         <small class="help-text" data-i18n="helpRidOpNum">Må bestå av nøyaktig 16 tegn (a-z, 0-9). Ingen bindestreker.</small>
                    </div>

                    <div id="ecOtherContainer" class="hidden" style="margin-top: 5px;">
                        <input type="text" id="ecOtherText" name="ecOtherText" placeholder="...">
                    </div>
                </div>
            </section>

            <section class="card form-section">
                <h2 data-i18n="sect3Header">3. Flyging og Rute</h2>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="depPlace" class="required" data-i18n="lblDepPlace">Avgangssted:</label>
                        <input type="text" id="depPlace" name="depPlace" required>
                    </div>
                    <div class="form-group">
                        <label for="depTime" class="required" data-i18n="lblDepTime">Avgangstid (UTC/Lokal):</label>
                        <input type="datetime-local" id="depTime" name="depTime" required>
                    </div>
                </div>

                <div class="grid-2" style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="arrPlace" class="required" data-i18n="lblArrPlace">Landingssted:</label>
                        <input type="text" id="arrPlace" name="arrPlace" required>
                    </div>
                    <div class="form-group">
                        <label for="arrTime" class="required" data-i18n="lblArrTime">Landingstid (Estimert):</label>
                        <input type="datetime-local" id="arrTime" name="arrTime" required>
                    </div>
                </div>

                <div class="grid-2" style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="altitudeVal" class="required" data-i18n="lblAltitude">Planlagt Høyde:</label>
                        <div class="input-group">
                            <input type="number" id="altitudeVal" name="altitudeVal" required>
                            <select name="altitudeRef" id="altitudeRef" style="flex: 0 0 120px;">
                                <option value="ft AGL">ft AGL</option>
                                <option value="m AGL">m AGL</option>
                                <option value="ft AMSL">ft AMSL</option>
                                <option value="FL">Flight Level</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="speedVal" data-i18n="lblSpeed">Cruising Speed:</label>
                        <div class="input-group">
                            <input type="number" id="speedVal" name="speedVal">
                            <select id="speedUnit" name="speedUnit" style="flex: 0 0 80px;">
                                <option value="kt">kt</option>
                                <option value="m/s">m/s</option>
                                <option value="km/t">km/t</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="endurance" class="required">
                            <span data-i18n="lblEndurance">Endurance (hh:mm):</span>
                            <div class="tooltip-container">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text" data-i18n="tooltipEndurance">Hvor lenge dronen kan fly før den går tom for energi.</span>
                            </div>
                        </label>
                        
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="endurance" name="endurance" placeholder="hh:mm" required style="flex: 1;">
                            <label class="checkbox-group" style="margin: 0; white-space: nowrap;">
                                <input type="checkbox" id="enduranceNA" name="enduranceNA">
                                <span data-i18n="lblNA">N/A</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group full-width" style="margin-top: 25px;">
                    <label class="checkbox-single">
                        <input type="checkbox" id="comCheck" name="comCheck">
                        <span data-i18n="lblRadio">Vil ha kommunikasjon med ATC</span>
                    </label>
                    
                    <div id="comOptions" class="hidden" style="margin-left: 0; margin-top: 15px;">
                        <div class="checkbox-group no-indent">
                            <label><input type="checkbox" name="comMethods" value="Phone"> <span data-i18n="lblComPhone">Telefon</span></label>
                            <label><input type="checkbox" name="comMethods" value="Radio"> <span data-i18n="lblComRadio">Radio (VHF)</span></label>
                        </div>
                    </div>
                </div>

                <div class="map-section">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="label-heading" data-i18n="lblRouteMap">Ruteoversikt</span>
                        <div class="tooltip-container">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text" data-i18n="tooltipMap">Støtter: KML, GPX, GeoJSON.<br>Verktøy: Google Earth, geojson.io.</span>
                        </div>
                    </div>
                    
                    <p class="help-text" data-i18n="txtMapHelp">Tegn rute. Grønn markør = Start, Rød markør = Slutt.</p>
                    
                    <div class="map-controls no-print">
                        <input type="file" id="fileUpload" accept=".kml,.gpx,.json,.geojson" class="file-input">
                        <button type="button" class="btn-small" onclick="clearMap()" data-i18n="btnMapClear">Slett kartdata</button>
                    </div>

                    <div id="map"></div>
                    <div id="mapError" class="error-msg hidden" data-i18n="msgMapError">Kartdata mangler! Vennligst tegn en rute.</div>
                </div>
            </section>

            <div class="actions no-print" style="justify-content: space-between;">
                <button type="button" class="btn btn-outline-danger" onclick="clearForm()" data-i18n="btnReset">Tøm skjema</button>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="validateAndAction('json')" data-i18n="btnJson">Last ned Data (JSON)</button>
                    <button type="button" class="btn btn-primary" onclick="validateAndAction('print')" data-i18n="btnPdf">Last ned / Skriv ut (PDF)</button>
                </div>
            </div>

            <div class="info-box form-section">
                <h3 data-i18n="infoBoxHeader">Innsending</h3>
                <p data-i18n="infoSendTo">Sendes til:</p>
                <ul class="email-list">
                    <li data-i18n="emailCaa"><strong>Luftfartstilsynet:</strong> postmottak@caa.no</li>
                    <li><strong data-i18n="emailTollTitle">Toll / Forsvaret:</strong> <span data-i18n="emailTollDesc">Se veileder.</span></li>
                </ul>

                <div class="email-copy-container no-print">
                    <span class="email-copy-label" data-i18n="lblCopyEmails">Kopieringsvennlig linje:</span>
                    <div class="email-copy-field" id="emailCopyString">postmottak@caa.no</div>
                </div>

                <div class="disclaimer">
                    <strong data-i18n="disclaimerTitle">Merk:</strong>
                    <p id="footerDisclaimerText" style="margin-top: 2px;">
                        Operatøren er ansvarlig for alle tillatelser.
                        <a href="https://registrering.sensor.nsm.cloudgis.no/?initialLang=en" target="_blank">NSM Sensorregistrering</a>.
                    </p>
                </div>
            </div>

        </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    
    <script src="translations.js"></script>
    <script src="script.js"></script>
</body>
</html>